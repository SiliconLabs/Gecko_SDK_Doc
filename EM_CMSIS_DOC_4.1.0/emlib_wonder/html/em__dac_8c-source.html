<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Silicon Labs EFM32 emlib Peripheral Library: release/EM_CMSIS_P1_4.1.0/emlib/src/em_dac.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_99634199317e4752b1934502e0d836c4.html">release</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_382a31a6d951115af2a1e7624d96c391.html">EM_CMSIS_P1_4.1.0</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_2bb29a122c859e975fa16e4cc28d11d7.html">emlib</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f09ea23800c86a7e4fd7d642f3adf232.html">src</a></div>
<h1>em_dac.c</h1><a href="em__dac_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***************************************************************************/</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include "<a class="code" href="em__dac_8h.html">em_dac.h</a>"</span>
<a name="l00034"></a>00034 <span class="preprocessor">#if defined(DAC_COUNT) &amp;&amp; (DAC_COUNT &gt; 0)</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="em__cmu_8h.html">em_cmu.h</a>"</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include "<a class="code" href="em__assert_8h.html">em_assert.h</a>"</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include "<a class="code" href="em__bus_8h.html">em_bus.h</a>"</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="comment">/***************************************************************************/</span>
<a name="l00044"></a>00044 <span class="comment">/***************************************************************************/</span>
<a name="l00050"></a>00050 <span class="comment">/*******************************************************************************</span>
<a name="l00051"></a>00051 <span class="comment"> *******************************   DEFINES   ***********************************</span>
<a name="l00052"></a>00052 <span class="comment"> ******************************************************************************/</span>
<a name="l00053"></a>00053 
<a name="l00057"></a>00057 <span class="preprocessor">#define DAC_CH_VALID(ch)    ((ch) &lt;= 1)</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00060"></a>00060 <span class="preprocessor">#define DAC_MAX_CLOCK    1000000</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>
<a name="l00064"></a>00064 <span class="comment">/*******************************************************************************</span>
<a name="l00065"></a>00065 <span class="comment"> **************************   GLOBAL FUNCTIONS   *******************************</span>
<a name="l00066"></a>00066 <span class="comment"> ******************************************************************************/</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">/***************************************************************************/</span>
<a name="l00081"></a><a class="code" href="group__DAC.html#g3efabd2832fe5862fefd86e02accf2b8">00081</a> <span class="keywordtype">void</span> <a class="code" href="group__DAC.html#g3efabd2832fe5862fefd86e02accf2b8">DAC_Enable</a>(DAC_TypeDef *dac, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ch, <span class="keywordtype">bool</span> enable)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083   <span class="keyword">volatile</span> uint32_t *reg;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085   EFM_ASSERT(DAC_REF_VALID(dac));
<a name="l00086"></a>00086   EFM_ASSERT(DAC_CH_VALID(ch));
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   <span class="keywordflow">if</span> (!ch)
<a name="l00089"></a>00089   {
<a name="l00090"></a>00090     reg = &amp;(dac-&gt;CH0CTRL);
<a name="l00091"></a>00091   }
<a name="l00092"></a>00092   <span class="keywordflow">else</span>
<a name="l00093"></a>00093   {
<a name="l00094"></a>00094     reg = &amp;(dac-&gt;CH1CTRL);
<a name="l00095"></a>00095   }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097   <a class="code" href="group__BUS.html#gf8574f14855448ecae32c5a9dd0c7164">BUS_RegBitWrite</a>(reg, _DAC_CH0CTRL_EN_SHIFT, enable);
<a name="l00098"></a>00098 }
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">/***************************************************************************/</span>
<a name="l00118"></a><a class="code" href="group__DAC.html#ge8fd0951c9fd781d120c8d5e4ce7745d">00118</a> <span class="keywordtype">void</span> <a class="code" href="group__DAC.html#ge8fd0951c9fd781d120c8d5e4ce7745d">DAC_Init</a>(DAC_TypeDef *dac, <span class="keyword">const</span> <a class="code" href="structDAC__Init__TypeDef.html">DAC_Init_TypeDef</a> *init)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120   uint32_t tmp;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122   EFM_ASSERT(DAC_REF_VALID(dac));
<a name="l00123"></a>00123 
<a name="l00124"></a>00124   <span class="comment">/* Make sure both channels are disabled. */</span>
<a name="l00125"></a>00125   <a class="code" href="group__BUS.html#gf8574f14855448ecae32c5a9dd0c7164">BUS_RegBitWrite</a>(&amp;(dac-&gt;CH0CTRL), _DAC_CH0CTRL_EN_SHIFT, 0);
<a name="l00126"></a>00126   <a class="code" href="group__BUS.html#gf8574f14855448ecae32c5a9dd0c7164">BUS_RegBitWrite</a>(&amp;(dac-&gt;CH1CTRL), _DAC_CH0CTRL_EN_SHIFT, 0);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128   <span class="comment">/* Load proper calibration data depending on selected reference */</span>
<a name="l00129"></a>00129   <span class="keywordflow">switch</span> (init-&gt;<a class="code" href="structDAC__Init__TypeDef.html#aba3c2f375f398242af8585493db3212">reference</a>)
<a name="l00130"></a>00130   {
<a name="l00131"></a>00131     <span class="keywordflow">case</span> <a class="code" href="group__DAC.html#ggd68bed4b325435b9616fa26d0deb795920ea6e80881daf41ae1e4f2beffdd5a9">dacRef2V5</a>:
<a name="l00132"></a>00132       dac-&gt;CAL = DEVINFO-&gt;DAC0CAL1;
<a name="l00133"></a>00133       <span class="keywordflow">break</span>;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="keywordflow">case</span> <a class="code" href="group__DAC.html#ggd68bed4b325435b9616fa26d0deb7959a0961407b52a7bacfecbb9651d401f18">dacRefVDD</a>:
<a name="l00136"></a>00136       dac-&gt;CAL = DEVINFO-&gt;DAC0CAL2;
<a name="l00137"></a>00137       <span class="keywordflow">break</span>;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="keywordflow">default</span>: <span class="comment">/* 1.25V */</span>
<a name="l00140"></a>00140       dac-&gt;CAL = DEVINFO-&gt;DAC0CAL0;
<a name="l00141"></a>00141       <span class="keywordflow">break</span>;
<a name="l00142"></a>00142   }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   tmp = ((uint32_t)(init-&gt;<a class="code" href="structDAC__Init__TypeDef.html#c2a78ac49c096f75e15f257147b927a2">refresh</a>)     &lt;&lt; _DAC_CTRL_REFRSEL_SHIFT)
<a name="l00145"></a>00145         | (((uint32_t)(init-&gt;<a class="code" href="structDAC__Init__TypeDef.html#c68fb836392980739bcaa75c374a6f2b">prescale</a>) &lt;&lt; _DAC_CTRL_PRESC_SHIFT)
<a name="l00146"></a>00146            &amp; _DAC_CTRL_PRESC_MASK)
<a name="l00147"></a>00147         | ((uint32_t)(init-&gt;<a class="code" href="structDAC__Init__TypeDef.html#aba3c2f375f398242af8585493db3212">reference</a>) &lt;&lt; _DAC_CTRL_REFSEL_SHIFT)
<a name="l00148"></a>00148         | ((uint32_t)(init-&gt;<a class="code" href="structDAC__Init__TypeDef.html#1a325a0e267d6e5ddaebd6c29a43d3dc">outMode</a>)   &lt;&lt; _DAC_CTRL_OUTMODE_SHIFT)
<a name="l00149"></a>00149         | ((uint32_t)(init-&gt;<a class="code" href="structDAC__Init__TypeDef.html#4be396b11559d58b038c784907d57f72">convMode</a>)  &lt;&lt; _DAC_CTRL_CONVMODE_SHIFT);
<a name="l00150"></a>00150 
<a name="l00151"></a>00151   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structDAC__Init__TypeDef.html#97e40c412e345048f170344ae0c9ef11">ch0ResetPre</a>)
<a name="l00152"></a>00152   {
<a name="l00153"></a>00153     tmp |= DAC_CTRL_CH0PRESCRST;
<a name="l00154"></a>00154   }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structDAC__Init__TypeDef.html#87b55620482ad0a5bbd1e53e880a4abc">outEnablePRS</a>)
<a name="l00157"></a>00157   {
<a name="l00158"></a>00158     tmp |= DAC_CTRL_OUTENPRS;
<a name="l00159"></a>00159   }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structDAC__Init__TypeDef.html#f28974c94c029aeace7d3d3c27d17d75">sineEnable</a>)
<a name="l00162"></a>00162   {
<a name="l00163"></a>00163     tmp |= DAC_CTRL_SINEMODE;
<a name="l00164"></a>00164   }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structDAC__Init__TypeDef.html#7b6c42818760a114ee9c4266f42d7ea1">diff</a>)
<a name="l00167"></a>00167   {
<a name="l00168"></a>00168     tmp |= DAC_CTRL_DIFF;
<a name="l00169"></a>00169   }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171   dac-&gt;CTRL = tmp;
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="comment">/***************************************************************************/</span>
<a name="l00188"></a><a class="code" href="group__DAC.html#gf77b8f5a47f5420264a2b3562664fa0d">00188</a> <span class="keywordtype">void</span> <a class="code" href="group__DAC.html#gf77b8f5a47f5420264a2b3562664fa0d">DAC_InitChannel</a>(DAC_TypeDef *dac,
<a name="l00189"></a>00189                      <span class="keyword">const</span> <a class="code" href="structDAC__InitChannel__TypeDef.html">DAC_InitChannel_TypeDef</a> *init,
<a name="l00190"></a>00190                      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ch)
<a name="l00191"></a>00191 {
<a name="l00192"></a>00192   uint32_t tmp;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194   EFM_ASSERT(DAC_REF_VALID(dac));
<a name="l00195"></a>00195   EFM_ASSERT(DAC_CH_VALID(ch));
<a name="l00196"></a>00196 
<a name="l00197"></a>00197   tmp = (uint32_t)(init-&gt;<a class="code" href="structDAC__InitChannel__TypeDef.html#e2d2d02f38c842a86e076aa42ea37974">prsSel</a>) &lt;&lt; _DAC_CH0CTRL_PRSSEL_SHIFT;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structDAC__InitChannel__TypeDef.html#c49bf6cdbe348a2305e39002ba1c4487">enable</a>)
<a name="l00200"></a>00200   {
<a name="l00201"></a>00201     tmp |= DAC_CH0CTRL_EN;
<a name="l00202"></a>00202   }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structDAC__InitChannel__TypeDef.html#df71487a252c4aebc69789688654aeb7">prsEnable</a>)
<a name="l00205"></a>00205   {
<a name="l00206"></a>00206     tmp |= DAC_CH0CTRL_PRSEN;
<a name="l00207"></a>00207   }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structDAC__InitChannel__TypeDef.html#e271f5f72c6a119598dc83b2ff258997">refreshEnable</a>)
<a name="l00210"></a>00210   {
<a name="l00211"></a>00211     tmp |= DAC_CH0CTRL_REFREN;
<a name="l00212"></a>00212   }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   <span class="keywordflow">if</span> (ch)
<a name="l00215"></a>00215   {
<a name="l00216"></a>00216     dac-&gt;CH1CTRL = tmp;
<a name="l00217"></a>00217   }
<a name="l00218"></a>00218   <span class="keywordflow">else</span>
<a name="l00219"></a>00219   {
<a name="l00220"></a>00220     dac-&gt;CH0CTRL = tmp;
<a name="l00221"></a>00221   }
<a name="l00222"></a>00222 }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="comment">/***************************************************************************/</span>
<a name="l00242"></a><a class="code" href="group__DAC.html#g8f0091a380e451ca9b79956556b94195">00242</a> <span class="keywordtype">void</span> <a class="code" href="group__DAC.html#g8f0091a380e451ca9b79956556b94195">DAC_ChannelOutputSet</a>( DAC_TypeDef *dac,
<a name="l00243"></a>00243                            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> channel,
<a name="l00244"></a>00244                            uint32_t     value )
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246   <span class="keywordflow">switch</span>(channel)
<a name="l00247"></a>00247   {
<a name="l00248"></a>00248     <span class="keywordflow">case</span> 0:
<a name="l00249"></a>00249       <a class="code" href="group__DAC.html#g8c99169a36fa3e2689e00d41fda5a6be">DAC_Channel0OutputSet</a>(dac, value);
<a name="l00250"></a>00250       <span class="keywordflow">break</span>;
<a name="l00251"></a>00251     <span class="keywordflow">case</span> 1:
<a name="l00252"></a>00252       <a class="code" href="group__DAC.html#g1ea9a1f5611a62d97fe36c3f943a14d2">DAC_Channel1OutputSet</a>(dac, value);
<a name="l00253"></a>00253       <span class="keywordflow">break</span>;
<a name="l00254"></a>00254     <span class="keywordflow">default</span>:
<a name="l00255"></a>00255       EFM_ASSERT(0);
<a name="l00256"></a>00256       <span class="keywordflow">break</span>;
<a name="l00257"></a>00257   }
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 <span class="comment">/***************************************************************************/</span>
<a name="l00282"></a><a class="code" href="group__DAC.html#ge0b4477588f4b20c488bc6483739b562">00282</a> uint8_t <a class="code" href="group__DAC.html#ge0b4477588f4b20c488bc6483739b562">DAC_PrescaleCalc</a>(uint32_t dacFreq, uint32_t hfperFreq)
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284   uint32_t ret;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286   <span class="comment">/* Make sure selected DAC clock is below max value */</span>
<a name="l00287"></a>00287   <span class="keywordflow">if</span> (dacFreq &gt; DAC_MAX_CLOCK)
<a name="l00288"></a>00288   {
<a name="l00289"></a>00289     dacFreq = DAC_MAX_CLOCK;
<a name="l00290"></a>00290   }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292   <span class="comment">/* Use current HFPER frequency? */</span>
<a name="l00293"></a>00293   <span class="keywordflow">if</span> (!hfperFreq)
<a name="l00294"></a>00294   {
<a name="l00295"></a>00295     hfperFreq = <a class="code" href="group__CMU.html#gc9aa0ed17f83bd48abcf7b430843374a">CMU_ClockFreqGet</a>(<a class="code" href="group__CMU.html#gg519ea66a1a21e07f2d1cccc9aa55799efdbf6d011629cb273654aa780dc3d00f">cmuClock_HFPER</a>);
<a name="l00296"></a>00296   }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298   <span class="comment">/* Iterate in order to determine best prescale value. Only a few possible */</span>
<a name="l00299"></a>00299   <span class="comment">/* values. We start with lowest prescaler value in order to get first */</span>
<a name="l00300"></a>00300   <span class="comment">/* equal or below wanted DAC frequency value. */</span>
<a name="l00301"></a>00301   <span class="keywordflow">for</span> (ret = 0; ret &lt;= (_DAC_CTRL_PRESC_MASK &gt;&gt; _DAC_CTRL_PRESC_SHIFT); ret++)
<a name="l00302"></a>00302   {
<a name="l00303"></a>00303     <span class="keywordflow">if</span> ((hfperFreq &gt;&gt; ret) &lt;= dacFreq)
<a name="l00304"></a>00304       <span class="keywordflow">break</span>;
<a name="l00305"></a>00305   }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307   <span class="comment">/* If ret is higher than the max prescaler value, make sure to return</span>
<a name="l00308"></a>00308 <span class="comment">     the max value. */</span>
<a name="l00309"></a>00309   <span class="keywordflow">if</span> (ret &gt; (_DAC_CTRL_PRESC_MASK &gt;&gt; _DAC_CTRL_PRESC_SHIFT))
<a name="l00310"></a>00310   {
<a name="l00311"></a>00311     ret = _DAC_CTRL_PRESC_MASK &gt;&gt; _DAC_CTRL_PRESC_SHIFT;
<a name="l00312"></a>00312   }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314   <span class="keywordflow">return</span> (uint8_t)ret;
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 <span class="comment">/***************************************************************************/</span>
<a name="l00325"></a><a class="code" href="group__DAC.html#g00ce350b6aa3bad03cf665702f714e59">00325</a> <span class="keywordtype">void</span> <a class="code" href="group__DAC.html#g00ce350b6aa3bad03cf665702f714e59">DAC_Reset</a>(DAC_TypeDef *dac)
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327   <span class="comment">/* Disable channels, before resetting other registers. */</span>
<a name="l00328"></a>00328   dac-&gt;CH0CTRL  = _DAC_CH0CTRL_RESETVALUE;
<a name="l00329"></a>00329   dac-&gt;CH1CTRL  = _DAC_CH1CTRL_RESETVALUE;
<a name="l00330"></a>00330   dac-&gt;CTRL     = _DAC_CTRL_RESETVALUE;
<a name="l00331"></a>00331   dac-&gt;IEN      = _DAC_IEN_RESETVALUE;
<a name="l00332"></a>00332   dac-&gt;IFC      = _DAC_IFC_MASK;
<a name="l00333"></a>00333   dac-&gt;CAL      = DEVINFO-&gt;DAC0CAL0;
<a name="l00334"></a>00334   dac-&gt;BIASPROG = _DAC_BIASPROG_RESETVALUE;
<a name="l00335"></a>00335   <span class="comment">/* Do not reset route register, setting should be done independently */</span>
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 
<a name="l00341"></a>00341 <span class="preprocessor">#endif </span><span class="comment">/* defined(DAC_COUNT) &amp;&amp; (DAC_COUNT &gt; 0) */</span>
</pre></div><div id="footer">
<hr size="1"><address style="text-align: right;"><small>
Generated on Thu Sep 10 08:11:21 2015</small> for Silicon Labs EFM32 emlib Peripheral Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a><small> 1.4.7 </small></address></div>
</body>
</html>
